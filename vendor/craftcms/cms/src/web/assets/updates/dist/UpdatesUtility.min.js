!function(a){Craft.UpdatesUtility=Garnish.Base.extend({$body:null,totalAvailableUpdates:0,criticalUpdateAvailable:!1,showUpdateAllBtn:!0,updates:null,init:function(){this.$body=Craft.cp.$content.children(".body");var b=a("#graphic"),c=a("#status");this.updates=[];var d={forceRefresh:!0,includeDetails:!0};Craft.postActionRequest("app/check-for-updates",d,a.proxy(function(d,e){if("success"!==e||d.error){var f=Craft.t("app","An unknown error occurred.");d.errors&&d.errors.length?f=d.errors[0]:d.error&&(f=d.error),b.addClass("error"),c.text(f)}else{if(d.updates.app&&this.processUpdate(d.updates.app,!1),d.updates.plugins&&d.updates.plugins.length)for(var g=0;g<d.updates.plugins.length;g++)this.processUpdate(d.updates.plugins[g],!0);if(this.totalAvailableUpdates){b.remove(),c.remove();var h;if(h=1===this.totalAvailableUpdates?Craft.t("app","1 Available Update"):Craft.t("app","{num} Available Updates",{num:this.totalAvailableUpdates}),a("#page-title h1").text(h),this.showUpdateAllBtn&&this.updates.length>1){var i=a("<div/>",{class:"btn submit",text:Craft.t("app","Update all")}).appendTo(a("<div/>",{id:"extra-headers"}).appendTo(Craft.cp.$pageHeader));this.addListener(i,"click","updateAll")}}else b.addClass("success"),c.text(Craft.t("app","You’re all up-to-date!"))}},this))},processUpdate:function(a,c){a.releases&&a.releases.length&&(this.totalAvailableUpdates++,this.updates.push(new b(this,a,c)))},updateAll:function(){this.redirectToUpdate(this.updates)},redirectToUpdate:function(a){window.location.href=this.buildUpdateUrl(a)},buildUpdateUrl:function(a){return Craft.getUrl("update",{install:this.buildRequirements(a)})},buildRequirements:function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].getHandle()+":"+a[c].latestAllowedVersion);return b.join(",")}});var b=Garnish.Base.extend({updateInfo:null,isPlugin:null,latestVersion:null,latestAllowedVersion:null,$container:null,$header:null,$contents:null,$ineligibleReleasesContainer:null,$showIneligibleReleasesLink:null,$releaseContainer:null,$showAllLink:null,licenseHud:null,$licenseSubmitBtn:null,licenseSubmitAction:null,init:function(b,c,d){this.updatesPage=b,this.updateInfo=c,this.isPlugin=d,this.createPane(),this.initReleases(),this.createHeading(),this.createUpdateButtons(),this.updateInfo.breakpoint?a('<blockquote class="note ineligible"><p><strong>You’ve reached a breakpoint!</strong> More updates will become available after you install Doxter 3.1.3.</p>').insertBefore(this.$releaseContainer):this.updateInfo.expired&&a('<blockquote class="note ineligible"><p><strong>Your license has expired!</strong> Renew your Craft CMS license for another year of amazing updates.</p>').insertBefore(this.$releaseContainer),(this.updateInfo.expired||this.updateInfo.licenseUpdated||null===this.latestAllowedVersion)&&(this.updatesPage.showUpdateAllBtn=!1)},getDisplayName:function(){return this.isPlugin?this.updateInfo.displayName:"Craft CMS"},getHandle:function(){return this.isPlugin?this.updateInfo.handle:"craft"},canUpdateToLatest:function(){return this.latestAllowedVersion===this.updateInfo.releases[0].version},createPane:function(){this.$container=a('<div class="update"/>').appendTo(this.updatesPage.$body),this.$header=a('<div class="update-header"/>').appendTo(this.$container),this.$contents=a('<div class="readable"/>').appendTo(this.$container),this.$releaseContainer=a('<div class="releases"/>').appendTo(this.$contents)},createHeading:function(){a('<div class="readable left"/>').appendTo(this.$header).append(a("<h1/>",{text:this.getDisplayName()}))},createUpdateButtons:function(){if(null!==this.latestAllowedVersion){var b=a('<div class="buttons right"/>').appendTo(this.$header);if(this.updateInfo.expired){a("<div/>",{class:"btn submit",text:"Renew for $59"}).appendTo(b)}else{var c=this.canUpdateToLatest()?Craft.t("app","Update"):Craft.t("app","Update to {version}",{version:this.latestAllowedVersion}),d=a('<div class="btn submit">'+c+"</div>").appendTo(b);this.updateInfo.licenseUpdated?this.addListener(d,"click","showLicenseForm"):this.addListener(d,"click",function(){this.updatesPage.redirectToUpdate([this])})}}},initReleases:function(){if(this.updateInfo.releases)for(var a=0;a<this.updateInfo.releases.length;a++)null===this.latestAllowedVersion&&this.updateInfo.releases[a].allowed&&(this.latestAllowedVersion=this.updateInfo.releases[a].version),new c(this,this.updateInfo.releases[a])},showLicenseForm:function(b){if(b.stopPropagation(),this.licenseHud)this.licenseHud.$trigger=a(b.currentTarget),this.licenseHud.show();else{var c=a("<div><p>"+Craft.t("app",'Craft’s <a href="http://craftcms.com/license" target="_blank">Terms and Conditions</a> have changed.')+"</p></div>"),d=a("<label> "+Craft.t("app","I agree.")+" &nbsp;</label>").appendTo(c),e=a('<input type="checkbox"/>').prependTo(d);this.$licenseSubmitBtn=a('<input class="btn submit" type="submit"/>').appendTo(c),this.licenseHud=new Garnish.HUD(b.currentTarget,c,{onSubmit:a.proxy(function(){e.prop("checked")?(this.licenseSubmitAction(),this.licenseHud.hide(),e.prop("checked",!1)):Garnish.shake(this.licenseHud.$hud)},this)})}this.$licenseSubmitBtn.attr("value",Craft.t("app","Seriously, update.")),this.licenseSubmitAction=this.redirectToUpdate}}),c=Garnish.Base.extend({update:null,releaseInfo:null,notesId:null,$container:null,$toggle:null,init:function(a,b){this.update=a,this.releaseInfo=b,this.notesId="notes-"+Math.floor(1e6*Math.random()),this.createContainer(),this.createHeading(),this.createReleaseNotes(),new Craft.FieldToggle(this.$toggle)},createContainer:function(){this.$container=a('<div class="pane release"/>').appendTo(this.update.$releaseContainer),this.releaseInfo.critical&&this.$container.addClass("critical")},createHeading:function(){this.$toggle=a("<a/>",{class:"fieldtoggle","data-target":this.notesId}).appendTo(this.$container),a("<h2/>",{text:this.releaseInfo.version}).appendTo(this.$toggle),this.releaseInfo.critical&&a("<strong/>",{class:"critical",text:Craft.t("app","Critical")}).appendTo(this.$toggle),a("<span/>",{class:"date",text:Craft.formatDate(this.releaseInfo.date)}).appendTo(this.$toggle)},createReleaseNotes:function(){a("<div/>",{id:this.notesId,class:"hidden"}).appendTo(this.$container).append(a("<div/>",{class:"release-notes"}).html(this.releaseInfo.notes))}},{maxInitialUpdateHeight:500})}(jQuery);
//# sourceMappingURL=UpdatesUtility.min.js.map